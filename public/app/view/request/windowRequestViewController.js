/*
 * File: app/view/MyWindowViewController.js
 *
 * This file was generated by Sencha Architect version 4.0.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.2.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.2.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('InOut.view.request.windowRequestViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.windowrequestviewcontroller',

    init: function() {
        var me = this;
        if (me.getViewModel().data.showMode == 'New') {
            Ext.Ajax.request({
                url: '/currentuser',
                success: function(response) {
                    Ext.getCmp('absent_picker').setValue(Ext.decode(response.responseText).data.fullname);
                    Ext.getCmp('absent_fio').setValue(Ext.decode(response.responseText).data.fullname);
                    Ext.getCmp('absent_email').setValue(Ext.decode(response.responseText).data.email);
                    Ext.getCmp('absent_user').setValue(Ext.decode(response.responseText).data.login);
                }
            })
        }
    },

    requestbtnactionclick: function(btn) {
        var form = btn.up('form');
        switch (btn.action) {
            case 'addnewrequest':
                if (form.isValid()) {
                    $data = form.getForm().getValues();
                    console.log($data);
                    delete $data.approve_picker;
                    delete $data.absent_picker;
                    console.log($data);
                    if (form.getForm().getValues().approve_picker == form.getForm().getValues().approve_fio) {
                        Ext.Ajax.request({
                            scope: this,
                            method: 'POST',
                            url: '/addnewrequest',
                            params: {data: Ext.JSON.encode($data)},
                            success: function(response) {
                                form.up('window').hide();
                                if (Ext.decode(response.responseText).state == 'created & approved') {
                                    Ext.Msg.alert('Уведомление','Заявка согласована автоматически.');
                                }  else {
                                    if (Ext.decode(response.responseText).state == 'created') {
                                        Ext.lib.customFunctions.showToast('Создана новая заявка.');
                                    } else {
                                        Ext.Msg.alert('Ошибка','Что-то пошло не так...');
                                    }
                                }
                                console.log(response.responseText);
                                Ext.getStore('storeOutgoingRequests').reload();
                                Ext.getStore('storeIncomingRequests').reload();
                                form.up('window').close();
                            },
                            failure: function (response) {
                                console.log(response.responseText);
                                //
                            }
                        });
                    } else {
                        Ext.lib.customFunctions.showToast('ФИО руководителя должно совпадать с выбранным из выпадающего списка!');
                    }
                } else {
                    Ext.Msg.alert('Ошибка!','Необходимо выбрать ФИО руководителя из выпадающего списка');
                }
                break;
            case 'close':
                form.up('window').close();
                break;
            case 'approverequest':
                var array = [];
                array.push(form.getForm().getValues().id);
                if (form.isValid()) {
                    Ext.Ajax.request({
                        scope: this,
                        method: 'POST',
                        url: '/approverequests',
                        params: {data: Ext.JSON.encode(array)},
                        success: function(response) {
                            form.up('window').hide();
                            //console.log(Ext.decode(response.responseText));
                            Ext.getStore('storeOutgoingRequests').reload();
                            Ext.getStore('storeIncomingRequests').reload();
                            console.log('Согласованные: ' + Ext.decode(response.responseText).approved)
                            if (Ext.decode(response.responseText).failed.length == 0) {
                                Ext.lib.customFunctions.showToast('Заявка согласована успешно');
                            } else {
                                Ext.lib.customFunctions.showToast('Заявка уже была обработана ранее');
                            }
                            form.up('window').close();
                        }
                    });
                } else {
                    Ext.Msg.alert('Ошибка!','Что то не так...');
                }
                break;
            case 'declinerequest':
                var array = [];
                array.push(form.getForm().getValues().id);
                if (form.isValid()) {
                    Ext.Ajax.request({
                        scope: this,
                        method: 'POST',
                        url: '/declinerequests',
                        params: {data: Ext.JSON.encode(array)},
                        success: function(response) {
                            form.up('window').hide();
                            Ext.getStore('storeOutgoingRequests').reload();
                            Ext.getStore('storeIncomingRequests').reload();

                            if (Ext.decode(response.responseText).failed.length == 0) {
                                Ext.lib.customFunctions.showToast('Заявка отклонена')
                            } else {
                                Ext.lib.customFunctions.showToast('Заявка уже была обработана ранее')
                            }
                            form.up('window').close();
                        }
                    });
                } else {
                    Ext.Msg.alert('Ошибка!','Что то не так...');
                }
                break;
        }
    }
});
